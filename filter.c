#include <stdio.h>
#include "filter.h"

static float filter_taps[SAMPLEFILTER_TAP_NUM] = {
  -0.01484709448494628,
  0.0012781727407830434,
  0.0018232032747038896,
  0.0026805217764799497,
  0.0037568480148600695,
  0.004938501587220719,
  0.0060978670037896456,
  0.0070950103876230375,
  0.007812932646623593,
  0.00813745184628729,
  0.007989992748121946,
  0.007329735646377314,
  0.006162621190081127,
  0.00454424096258551,
  0.0025751661752998244,
  0.00040072232730972376,
  -0.0018040316579069592,
  -0.0038464501688857985,
  -0.005534463328079365,
  -0.006693968962171669,
  -0.007187146950692478,
  -0.006928426875206623,
  -0.005897708236770574,
  -0.004146173714287483,
  -0.0017971617384214451,
  0.0009586036557871535,
  0.003877232243090202,
  0.006675952363415796,
  0.00906509227720653,
  0.010765565047027692,
  0.011540603307713039,
  0.011221958208809607,
  0.00972697523289332,
  0.007094906090839284,
  0.0034390358294052593,
  -0.0009823755073257753,
  -0.005825456129935689,
  -0.010667458617739187,
  -0.015036179697726979,
  -0.01848323759222245,
  -0.020454797876041465,
  -0.020621553949575325,
  -0.01865826983706397,
  -0.014386017148773252,
  -0.007773311568721212,
  0.0010502025805976228,
  0.011787978054780608,
  0.02400263712332146,
  0.0371248420474072,
  0.05049694576033376,
  0.06341235080025746,
  0.07516381475730088,
  0.08509143390364955,
  0.09262573570021196,
  0.09733010743695283,
  0.09892942726559703,
  0.09733010743695283,
  0.09262573570021196,
  0.08509143390364955,
  0.07516381475730088,
  0.06341235080025746,
  0.05049694576033376,
  0.0371248420474072,
  0.02400263712332146,
  0.011787978054780608,
  0.0010502025805976228,
  -0.007773311568721212,
  -0.014386017148773252,
  -0.01865826983706397,
  -0.020621553949575325,
  -0.020454797876041465,
  -0.01848323759222245,
  -0.015036179697726979,
  -0.010667458617739187,
  -0.005825456129935689,
  -0.0009823755073257753,
  0.0034390358294052593,
  0.007094906090839284,
  0.00972697523289332,
  0.011221958208809607,
  0.011540603307713039,
  0.010765565047027692,
  0.00906509227720653,
  0.006675952363415796,
  0.003877232243090202,
  0.0009586036557871535,
  -0.0017971617384214451,
  -0.004146173714287483,
  -0.005897708236770574,
  -0.006928426875206623,
  -0.007187146950692478,
  -0.006693968962171669,
  -0.005534463328079365,
  -0.0038464501688857985,
  -0.0018040316579069592,
  0.00040072232730972376,
  0.0025751661752998244,
  0.00454424096258551,
  0.006162621190081127,
  0.007329735646377314,
  0.007989992748121946,
  0.00813745184628729,
  0.007812932646623593,
  0.0070950103876230375,
  0.0060978670037896456,
  0.004938501587220719,
  0.0037568480148600695,
  0.0026805217764799497,
  0.0018232032747038896,
  0.0012781727407830434,
  -0.01484709448494628
};

void SampleFilter_init(SampleFilter* f) 
{
  int i;
  for(i = 0; i < SAMPLEFILTER_TAP_NUM; ++i)
  {
    f->history_i[i] = 0;
    f->history_q[i] = 0;
  }
  f->last_index = 0;
}

void SampleFilter_put(SampleFilter* f, float input_i, float input_q)
{
  f->history_i[f->last_index] = input_i;
  f->history_q[f->last_index] = input_q;
  f->last_index++;
  if(f->last_index == SAMPLEFILTER_TAP_NUM)
    f->last_index = 0;
}

void SampleFilter_get(SampleFilter* f, float *i_out, float *q_out) 
{
    float acc_i = 0;
    float acc_q = 0;
    int index = f->last_index, i;

    for(i = 0; i < SAMPLEFILTER_TAP_NUM; ++i) 
    {
        index = index != 0 ? index-1 : SAMPLEFILTER_TAP_NUM-1;
        acc_i += f->history_i[index] * filter_taps[i];
        acc_q += f->history_q[index] * filter_taps[i];
    };
    *i_out = acc_i;
    *q_out = acc_q;
}